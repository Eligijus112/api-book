
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gunicorn &#8212; Machine Learning serving</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Docker in production" href="docker.html" />
    <link rel="prev" title="API and PSQL integration example" href="../chapter-5-API/API-example.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Machine Learning serving</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   Introduction
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Hardware and Linux OS
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-1-computer/computer-specs.html">
   Building blocks of a computer
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-1-computer/computer-OS.html">
   Linux operating system
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Software for an ML developer
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-2-software/python-intro.html">
   Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-2-software/virtual-envs.html">
   Virtual environments
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-2-software/docker.html">
   Docker
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Python Programming
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-3-python/object-oriented-programming.html">
   Classes and objects
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-3-python/data-types.html">
   Data types
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-3-python/data-structures.html">
   Data structures
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Machine learning
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-4-ML/machine-learning-model.html">
   Creating machine learning models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-4-ML/machine-learning-model-serving.html">
   Basic ML serving
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  API
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-5-API/API-intro.html">
   Application Programming Interface basics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-5-API/API-server.html">
   API server
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-5-API/API-DB.html">
   Databases and Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-5-API/API-example.html">
   API and PSQL integration example
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Production Tools and Concepts
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Gunicorn
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="docker.html">
   Docker in production
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="JWT.html">
   JWT based authentification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="migrations.html">
   Migrations
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  ML serving API
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-7-final-serving/users.html">
   ML users
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-7-final-serving/authentification.html">
   ML users authentification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-7-final-serving/machine_learning_model.html">
   ML model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-7-final-serving/machine_learning_db_models.html">
   ML database models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-7-final-serving/machine_learning_api.html">
   Machine learning API
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-7-final-serving/machine_learning_api_production.html">
   Wrapping the API into a production container
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Bibliography
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../references/references.html">
   Links and references
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/chapter-6-production-tools/gunicorn.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/Eligijus112/api-book"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/Eligijus112/api-book/issues/new?title=Issue%20on%20page%20%2Fchapter-6-production-tools/gunicorn.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/Eligijus112/api-book/master?urlpath=tree/docs/chapter-6-production-tools/gunicorn.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Gunicorn
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#gunicorn-and-uvicorn">
   Gunicorn and Uvicorn
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#api-example-with-gunicorn-and-uvicorn">
   API example with Gunicorn and Uvicorn
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#detailed-explanation-of-what-happened">
     Detailed explanation of what happened
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#managing-gunicorn-in-ubuntu-with-supervisor">
   Managing Gunicorn in Ubuntu with supervisor
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#supervisor-configuration">
     Supervisor configuration
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#putting-it-all-inside-a-container">
   Putting it all inside a container
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="gunicorn">
<h1>Gunicorn<a class="headerlink" href="#gunicorn" title="Permalink to this headline">¶</a></h1>
<p>The last piece of software which we need to build a production ready API is Gunicorn. Gunicorn is a Python web server that is used to run the API. To be more technical, Gunicorn is a <code class="docutils literal notranslate"><span class="pre">Python</span> <span class="pre">Web</span> <span class="pre">Server</span> <span class="pre">Gateway</span> <span class="pre">Interface</span> <span class="pre">(WSGI)</span> <span class="pre">HTTP</span> <span class="pre">server</span></code>. To read the official documentation of Gunicorn, visit: <a class="reference external" href="https://docs.gunicorn.org/en/stable/">https://docs.gunicorn.org/en/stable/</a>.</p>
<p>In a previous chapter we have explained what is an asynchronous web server interface. The main difference between ASGI and WSGI servers is that WSGI servers must wait for the workers that it is managing to complete their work before giving them another task (this is sometimes called blocking).</p>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="gunicorn-and-uvicorn">
<h1>Gunicorn and Uvicorn<a class="headerlink" href="#gunicorn-and-uvicorn" title="Permalink to this headline">¶</a></h1>
<p>In the previous chapter, we have used the Uvicorn server with the FastAPI framework. Gunicorn will be used on top of that and will spawn multiple small uvicorn servers (workers) to handle the requests.</p>
<p>Using that combination, Gunicorn would act as a process manager, listening on the port and the IP. And it would transmit the communication to the worker processes running the Uvicorn class.
And then the Gunicorn-compatible Uvicorn worker class would be in charge of converting the data sent by Gunicorn to the ASGI standard for FastAPI to use it.</p>
<p><img alt="gunicorn-uvicorn" src="../_images/gunicorn-uvicorn.png" /></p>
<p>Each request is first handled by the Gunicorn server. Then, the server reroutes it to the least busy uvicorn worker. Because uvicorn is an ASGI server, each worker can process requests asyncronously thus even a small number of worker uvicorn processes can handle a large number of requests.</p>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="api-example-with-gunicorn-and-uvicorn">
<h1>API example with Gunicorn and Uvicorn<a class="headerlink" href="#api-example-with-gunicorn-and-uvicorn" title="Permalink to this headline">¶</a></h1>
<p>Lets use the same API code as in the previous chapter. The API accepts a number in a request and responds with the n-th root of it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>cat gunicorn-api-example/get_n_root.py
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span># Importing the fastAPI library
from fastapi import FastAPI

# Creating an instance of the FastAPI class
app = FastAPI()

# Creating an endpoint with the GET method
@app.get(&quot;/root&quot;)
def root_of_number(number: float, n: float):
    &quot;&quot;&quot;
    The function returns the n-th root of the number.
    Parameters
    ----------
    number : float
        The number to find the n-th root of.
    n : float
        The n-th root to find.
    Returns
    -------
    float
        The n-th root of the number.
    &quot;&quot;&quot;
    return {&quot;root&quot;: number ** n} 
</pre></div>
</div>
</div>
</div>
<p>Previously, to serve the above API code, we would run the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">uvicorn</span> <span class="n">gunicorn</span><span class="o">-</span><span class="n">api</span><span class="o">-</span><span class="n">example</span><span class="o">.</span><span class="n">get_n_root</span><span class="p">:</span><span class="n">app</span>
</pre></div>
</div>
<p>Which would result in the terminal message like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INFO</span><span class="p">:</span>     <span class="n">Started</span> <span class="n">server</span> <span class="n">process</span> <span class="p">[</span><span class="mi">13880</span><span class="p">]</span>
<span class="n">INFO</span><span class="p">:</span>     <span class="n">Waiting</span> <span class="k">for</span> <span class="n">application</span> <span class="n">startup</span><span class="o">.</span>
<span class="n">INFO</span><span class="p">:</span>     <span class="n">Application</span> <span class="n">startup</span> <span class="n">complete</span><span class="o">.</span>
<span class="n">INFO</span><span class="p">:</span>     <span class="n">Uvicorn</span> <span class="n">running</span> <span class="n">on</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">8000</span> <span class="p">(</span><span class="n">Press</span> <span class="n">CTRL</span><span class="o">+</span><span class="n">C</span> <span class="n">to</span> <span class="n">quit</span><span class="p">)</span>
</pre></div>
</div>
<p>To spawn multiple uvicorn workers that are managed with Gunicorn we use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gunicorn</span> <span class="n">gunicorn</span><span class="o">-</span><span class="n">api</span><span class="o">-</span><span class="n">example</span><span class="o">.</span><span class="n">get_n_root</span><span class="p">:</span><span class="n">app</span> <span class="o">--</span><span class="n">workers</span> <span class="mi">4</span> <span class="o">--</span><span class="n">worker</span><span class="o">-</span><span class="k">class</span> <span class="nc">uvicorn</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">UvicornWorker</span> <span class="o">--</span><span class="n">bind</span> <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">8000</span>
</pre></div>
</div>
<p>Which would result in the terminal message like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span> <span class="mi">14</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">31</span> <span class="o">+</span><span class="mi">0200</span><span class="p">]</span> <span class="p">[</span><span class="mi">14017</span><span class="p">]</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">gunicorn</span> <span class="mf">20.1.0</span>
<span class="p">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span> <span class="mi">14</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">31</span> <span class="o">+</span><span class="mi">0200</span><span class="p">]</span> <span class="p">[</span><span class="mi">14017</span><span class="p">]</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Listening</span> <span class="n">at</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">8000</span> <span class="p">(</span><span class="mi">14017</span><span class="p">)</span>
<span class="p">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span> <span class="mi">14</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">31</span> <span class="o">+</span><span class="mi">0200</span><span class="p">]</span> <span class="p">[</span><span class="mi">14017</span><span class="p">]</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Using</span> <span class="n">worker</span><span class="p">:</span> <span class="n">uvicorn</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">UvicornWorker</span>
<span class="p">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span> <span class="mi">14</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">31</span> <span class="o">+</span><span class="mi">0200</span><span class="p">]</span> <span class="p">[</span><span class="mi">14019</span><span class="p">]</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Booting</span> <span class="n">worker</span> <span class="k">with</span> <span class="n">pid</span><span class="p">:</span> <span class="mi">14019</span>
<span class="p">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span> <span class="mi">14</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">31</span> <span class="o">+</span><span class="mi">0200</span><span class="p">]</span> <span class="p">[</span><span class="mi">14020</span><span class="p">]</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Booting</span> <span class="n">worker</span> <span class="k">with</span> <span class="n">pid</span><span class="p">:</span> <span class="mi">14020</span>
<span class="p">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span> <span class="mi">14</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">31</span> <span class="o">+</span><span class="mi">0200</span><span class="p">]</span> <span class="p">[</span><span class="mi">14019</span><span class="p">]</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Started</span> <span class="n">server</span> <span class="n">process</span> <span class="p">[</span><span class="mi">14019</span><span class="p">]</span>
<span class="p">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span> <span class="mi">14</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">31</span> <span class="o">+</span><span class="mi">0200</span><span class="p">]</span> <span class="p">[</span><span class="mi">14019</span><span class="p">]</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">application</span> <span class="n">startup</span><span class="o">.</span>
<span class="p">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span> <span class="mi">14</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">31</span> <span class="o">+</span><span class="mi">0200</span><span class="p">]</span> <span class="p">[</span><span class="mi">14019</span><span class="p">]</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Application</span> <span class="n">startup</span> <span class="n">complete</span><span class="o">.</span>
<span class="p">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span> <span class="mi">14</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">31</span> <span class="o">+</span><span class="mi">0200</span><span class="p">]</span> <span class="p">[</span><span class="mi">14020</span><span class="p">]</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Started</span> <span class="n">server</span> <span class="n">process</span> <span class="p">[</span><span class="mi">14020</span><span class="p">]</span>
<span class="p">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span> <span class="mi">14</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">31</span> <span class="o">+</span><span class="mi">0200</span><span class="p">]</span> <span class="p">[</span><span class="mi">14020</span><span class="p">]</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">application</span> <span class="n">startup</span><span class="o">.</span>
<span class="p">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span> <span class="mi">14</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">31</span> <span class="o">+</span><span class="mi">0200</span><span class="p">]</span> <span class="p">[</span><span class="mi">14020</span><span class="p">]</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Application</span> <span class="n">startup</span> <span class="n">complete</span><span class="o">.</span>
<span class="p">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span> <span class="mi">14</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">31</span> <span class="o">+</span><span class="mi">0200</span><span class="p">]</span> <span class="p">[</span><span class="mi">14021</span><span class="p">]</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Booting</span> <span class="n">worker</span> <span class="k">with</span> <span class="n">pid</span><span class="p">:</span> <span class="mi">14021</span>
<span class="p">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span> <span class="mi">14</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">31</span> <span class="o">+</span><span class="mi">0200</span><span class="p">]</span> <span class="p">[</span><span class="mi">14022</span><span class="p">]</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Booting</span> <span class="n">worker</span> <span class="k">with</span> <span class="n">pid</span><span class="p">:</span> <span class="mi">14022</span>
<span class="p">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span> <span class="mi">14</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">31</span> <span class="o">+</span><span class="mi">0200</span><span class="p">]</span> <span class="p">[</span><span class="mi">14021</span><span class="p">]</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Started</span> <span class="n">server</span> <span class="n">process</span> <span class="p">[</span><span class="mi">14021</span><span class="p">]</span>
<span class="p">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span> <span class="mi">14</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">31</span> <span class="o">+</span><span class="mi">0200</span><span class="p">]</span> <span class="p">[</span><span class="mi">14021</span><span class="p">]</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">application</span> <span class="n">startup</span><span class="o">.</span>
<span class="p">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span> <span class="mi">14</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">31</span> <span class="o">+</span><span class="mi">0200</span><span class="p">]</span> <span class="p">[</span><span class="mi">14021</span><span class="p">]</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Application</span> <span class="n">startup</span> <span class="n">complete</span><span class="o">.</span>
<span class="p">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span> <span class="mi">14</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">31</span> <span class="o">+</span><span class="mi">0200</span><span class="p">]</span> <span class="p">[</span><span class="mi">14022</span><span class="p">]</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Started</span> <span class="n">server</span> <span class="n">process</span> <span class="p">[</span><span class="mi">14022</span><span class="p">]</span>
<span class="p">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span> <span class="mi">14</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">31</span> <span class="o">+</span><span class="mi">0200</span><span class="p">]</span> <span class="p">[</span><span class="mi">14022</span><span class="p">]</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">application</span> <span class="n">startup</span><span class="o">.</span>
<span class="p">[</span><span class="mi">2021</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">24</span> <span class="mi">14</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">31</span> <span class="o">+</span><span class="mi">0200</span><span class="p">]</span> <span class="p">[</span><span class="mi">14022</span><span class="p">]</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Application</span> <span class="n">startup</span> <span class="n">complete</span><span class="o">.</span>
</pre></div>
</div>
<p>Now to access the API, visit: <a class="reference external" href="http://localhost:8000/root?number=25&amp;n=0.86">http://localhost:8000/root?number=25&amp;n=0.86</a>. The resulting JSON is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;root&quot;</span><span class="p">:</span><span class="mf">15.93046333819077</span><span class="p">}</span>
</pre></div>
</div>
<div class="section" id="detailed-explanation-of-what-happened">
<h2>Detailed explanation of what happened<a class="headerlink" href="#detailed-explanation-of-what-happened" title="Permalink to this headline">¶</a></h2>
<p>After running the gunicorn command, the first thing that the underlying OS system did was spawn a process with a PID of 14017 which is the Gunicorn server. This is the main server that reroutes everything to the workers.</p>
<p>Then, the Gunicorn server spawned 4 workers, each with a PID of 14019, 14020, 14021 and 14022. These workers are the uvicorn workers that are spawned by Gunicorn using the <code class="docutils literal notranslate"><span class="pre">uvicorn.workers.UvicornWorker</span></code> class. All we need to know about this is that the creators of uvicorn have integrated their API handling with Gunicorn and we can seemlessly use it with Gunicorn.</p>
<p>Lastly, we commanded Gunicorn to listed to the port 8000 and bind to the IP of localhost (or 0.0.0.0, or 127.0.0.1).</p>
<p>Thus, every time some packet of data comes to localhost:8000, Gunicorn will try to handle that data.</p>
<p>What is very helpful is that if a worker gets shutdown (too much data, worker crashes, the system runs out of RAM), Gunicorn will automatically spawn a new worker with a new PID.</p>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="managing-gunicorn-in-ubuntu-with-supervisor">
<h1>Managing Gunicorn in Ubuntu with supervisor<a class="headerlink" href="#managing-gunicorn-in-ubuntu-with-supervisor" title="Permalink to this headline">¶</a></h1>
<p>Gunicorn is a very powerfull tool to manage it’s workers. But what happens if Gunicorn server itself crashes? To solve this problem, we can use the <code class="docutils literal notranslate"><span class="pre">supervisor</span></code> tool in Ubuntu (many other Linux distributions have this tool as well). To read more about super visor, visit: <a class="reference external" href="http://supervisord.org/">http://supervisord.org/</a>.</p>
<p>To install it in Ubuntu, run the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">supervisor</span>
</pre></div>
</div>
<p>As the authors put it:
<code class="docutils literal notranslate"><span class="pre">Supervisor</span> <span class="pre">is</span> <span class="pre">a</span> <span class="pre">client/server</span> <span class="pre">system</span> <span class="pre">that</span> <span class="pre">allows</span> <span class="pre">its</span> <span class="pre">users</span> <span class="pre">to</span> <span class="pre">monitor</span> <span class="pre">and</span> <span class="pre">control</span> <span class="pre">a</span> <span class="pre">number</span> <span class="pre">of</span> <span class="pre">processes</span> <span class="pre">on</span> <span class="pre">UNIX-like</span> <span class="pre">operating</span> <span class="pre">systems.</span></code></p>
<p>The main benefit of supervisor is that we can restart and monitor the Gunicorn process. Thus, even if the whole Gunicorn server is down, we can easily restart it.</p>
<div class="section" id="supervisor-configuration">
<h2>Supervisor configuration<a class="headerlink" href="#supervisor-configuration" title="Permalink to this headline">¶</a></h2>
<p>All the different processes that are monitored by supervisor are stored in the <code class="docutils literal notranslate"><span class="pre">/etc/supervisor/conf.d</span></code> directory.</p>
<p>Each process needs to have a configuration file in this directory. The file name is the same as the process name. For example, if we want to monitor the Gunicorn server, we would create a file called <code class="docutils literal notranslate"><span class="pre">gunicorn.conf</span></code> in the <code class="docutils literal notranslate"><span class="pre">/etc/supervisor/conf.d</span></code> directory. The contents of the file:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>cat gunicorn-api-example/gunicorn.conf
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[program:gunicorn_api]
user=root
directory=/home/eligijus/api-book/api-book/chapter-6-production-tools/gunicorn-api-example/
command=/home/eligijus/api-book/api_book/bin/gunicorn get_n_root:app --workers 4 --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
 
autostart=true
autorestart=true
stdout_logfile=/var/log/root-api/gunicorn.log
stderr_logfile=/var/log/root-api/gunicorn.err.log
</pre></div>
</div>
</div>
</div>
<p>The first line defines the program name which we will use to start/restart/shutdown the process. The name for our API is <code class="docutils literal notranslate"><span class="pre">gunicorn_api</span></code></p>
<p>The second line defines the user that the process will run as. In this case, we will run the Gunicorn server as the user <code class="docutils literal notranslate"><span class="pre">root</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">directory</span></code> variable defines where all the code for the Gunicorn server is located.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">command</span></code> variable defines the command that will be executed when the process is started. We need to explicitly tell the supervisor where is the Gunicorn code. In our case, it is in the virtual environment directory <code class="docutils literal notranslate"><span class="pre">api_book/bin/gunicorn</span></code>. Everything to the right of the /bin/gunicorn command are the parameters for how the Gunicorn should start the server.</p>
<p><code class="docutils literal notranslate"><span class="pre">autostart</span></code>=true means that uppon Ubuntu system startup, the process will be started.</p>
<p><code class="docutils literal notranslate"><span class="pre">autorestart</span></code>=true means that the process will be restarted if it crashes.</p>
<p><code class="docutils literal notranslate"><span class="pre">stdout_logfile</span></code> defines the file where the standart ouptut of our process will go. These are all the user created print() statements and other messages.</p>
<p><code class="docutils literal notranslate"><span class="pre">stderr_logfile</span></code> defines the file where the standart error of our process will go. If anything goes wrong, it will go here.</p>
<p>To start the Gunicorn server, we run the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">supervisorctl</span> <span class="n">reread</span> 
<span class="n">sudo</span> <span class="n">supervisorctl</span> <span class="n">update</span>
<span class="n">sudo</span> <span class="n">supervisorctl</span> <span class="n">start</span> <span class="n">gunicorn_api</span>
</pre></div>
</div>
<p>To check the status of our API, we run the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">supervisorctl</span> <span class="n">status</span> <span class="n">gunicorn_api</span>
</pre></div>
</div>
<p>The output should look similar to the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gunicorn_api</span>                     <span class="n">RUNNING</span>   <span class="n">pid</span> <span class="mi">9352</span><span class="p">,</span> <span class="n">uptime</span> <span class="mi">0</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">47</span>
</pre></div>
</div>
<p>If the process is running, we can query our API by visiting: <a class="reference external" href="http://localhost:8000/root?number=25&amp;n=0.86">http://localhost:8000/root?number=25&amp;n=0.86</a>.</p>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="putting-it-all-inside-a-container">
<h1>Putting it all inside a container<a class="headerlink" href="#putting-it-all-inside-a-container" title="Permalink to this headline">¶</a></h1>
<p>By now, we have all the tools needed to run an API using Gunicorn, Uvicorn and FastAPI. To be able to scale and transfer our API code to multiple servers we need to use Docker and containerize the API.</p>
<p>This is what we will do in the next section.</p>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./chapter-6-production-tools"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="../chapter-5-API/API-example.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">API and PSQL integration example</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="docker.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">Docker in production</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Eligijus Bujokas<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>