
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ML users &#8212; Machine Learning serving</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="ML users authentification" href="authentification.html" />
    <link rel="prev" title="Migrations" href="../chapter-6-production-tools/migrations.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Machine Learning serving</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   Introduction
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Hardware and Linux OS
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-1-computer/computer-specs.html">
   Building blocks of a computer
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-1-computer/computer-OS.html">
   Linux operating system
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Software for an ML developer
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-2-software/python-intro.html">
   Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-2-software/virtual-envs.html">
   Virtual environments
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-2-software/docker.html">
   Docker
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Python Programming
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-3-python/object-oriented-programming.html">
   Classes and objects
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-3-python/data-types.html">
   Data types
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-3-python/data-structures.html">
   Data structures
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Machine learning
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-4-ML/machine-learning-model.html">
   Creating machine learning models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-4-ML/machine-learning-model-serving.html">
   Basic ML serving
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  API
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-5-API/API-intro.html">
   Application Programming Interface basics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-5-API/API-server.html">
   API server
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-5-API/API-DB.html">
   Databases and Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-5-API/API-example.html">
   API and PSQL integration example
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Production Tools and Concepts
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-6-production-tools/gunicorn.html">
   Gunicorn
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-6-production-tools/docker.html">
   Docker in production
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-6-production-tools/JWT.html">
   JWT based authentification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../chapter-6-production-tools/migrations.html">
   Migrations
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  ML serving API
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   ML users
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="authentification.html">
   ML users authentification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="machine_learning_model.html">
   ML model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="machine_learning_db_models.html">
   ML database models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="machine_learning_api.html">
   Machine learning API
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="machine_learning_api_production.html">
   Wrapping the API into a production container
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Bibliography
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../references/references.html">
   Links and references
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/chapter-7-final-serving/users.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/Eligijus112/api-book"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/Eligijus112/api-book/issues/new?title=Issue%20on%20page%20%2Fchapter-7-final-serving/users.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/Eligijus112/api-book/master?urlpath=tree/docs/chapter-7-final-serving/users.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   ML users
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#user-registration">
   User registration
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#password-obfuscation">
     Password obfuscation
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#user-registration-endpoints">
     User registration endpoints
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   Summary
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="ml-users">
<h1>ML users<a class="headerlink" href="#ml-users" title="Permalink to this headline">¶</a></h1>
<p>In this chapter we will build the final production grade API to serve machine learning models. We will expand on all the concepts covered so far and augment them. By the end, we will have a fully working API that can be deployed to production.</p>
<p>The whole API will be built from the <code class="docutils literal notranslate"><span class="pre">ML_API/</span></code> directory in the current chapter.</p>
<p>The first step is to create the user registration, authentification and deletion endpoints.</p>
<p>Be sure to start up the api with the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">uvicorn</span> <span class="n">app</span><span class="p">:</span><span class="n">app</span> <span class="o">--</span><span class="n">port</span> <span class="mi">8001</span>
</pre></div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="user-registration">
<h1>User registration<a class="headerlink" href="#user-registration" title="Permalink to this headline">¶</a></h1>
<p>Just as in the previous chapter, we will create an endpoint that registers a user. This time, we will add a layer of security: we will hash the password before storing it in the database. This is done because we don’t want to store plain text passwords in the database in case someone gets access to the database. To decrypt the password one needs to know the <code class="docutils literal notranslate"><span class="pre">secret</span> <span class="pre">key</span></code> which is only known to the server.</p>
<p>The full script for the <code class="docutils literal notranslate"><span class="pre">Users</span></code> model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>cat ML_API/Users.py
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span># ORM functions for the database 
from sqlalchemy.orm import declarative_base

# Model creation 
from sqlalchemy import Column, Integer, String, DateTime, Boolean

# Farnet package for password encription 
from cryptography.fernet import Fernet

# Configuration reading 
import yaml 

# Dates and times
import datetime

# OS traversal 
import os 

# Initiating the Base class
Base = declarative_base()

# Defining the path of the file 
_path = os.path.dirname(os.path.abspath(__file__))

# Reading the secrets 
with open(os.path.join(_path, &quot;config.yml&quot;), &#39;r&#39;) as f:
    secrets = yaml.safe_load(f.read()).get(&quot;secrets&quot;)
    secret_key = secrets.get(&quot;key&quot;).encode()
    secret_salt = secrets.get(&quot;salt&quot;)


class User(Base):
    # Table name in database
    __tablename__ = &#39;users&#39;
    
    # If any changes are made to the columns, allow the database to know about it
    __table_args__ = {&#39;extend_existing&#39;: True} 

    # Database columns
    id = Column(Integer, primary_key=True)
    username = Column(String)
    password = Column(String)
    email = Column(String)
    enabled = Column(Boolean)
    created_datetime = Column(DateTime)
    updated_datetime = Column(DateTime)

    @staticmethod
    def encrypt_string(string: str) -&gt; str:
        &quot;&quot;&quot;
        Method for encrypting a given string
        &quot;&quot;&quot;
        # Initiating the encriptor 
        _fernet = Fernet(secret_key)

        # Encrupting the string with the added salt 
        _encrypted_password = _fernet.encrypt(f&quot;{string}{secret_salt}&quot;.encode())
        
        # Returning the encrypted string
        return _encrypted_password.decode()

    def __init__(
        self,
        username: str, 
        password: str,
        email: str,
        enabled: bool = True,
        ):
        # Infering the time of creation 
        _cur_time = datetime.datetime.now()

        # Encripting the password at the time of creation
        # This will prevent the password from being stored in plain text and be extracted even by developers
        _encrypted_password = self.encrypt_string(password)

        # Variables for the object
        self.username = username 
        self.password = _encrypted_password
        self.email = email 
        self.enabled = enabled
        self.created_datetime = _cur_time
        self.updated_datetime = _cur_time

    def __str__(self):
        &quot;&quot;&quot;
        Method for developers to see the object in a readable format 
        &quot;&quot;&quot;
        return f&quot;User(username=&#39;{self.username}&#39;, password=&#39;{self.password}&#39;, email=&#39;{self.email}&#39;)&quot;

    def check_password_match(self, password: str) -&gt; bool:
        &quot;&quot;&quot;
        Method to check if the given password matches up with the one stored in object
        &quot;&quot;&quot;
        # Decrypting the password of the current user object in the database
        _fernet = Fernet(secret_key)
        _decrypted_password = _fernet.decrypt(self.password.encode())
        _decrypted_password = _decrypted_password.decode()

        # Adding the salt to the sent password
        _password_sent = f&quot;{password}{secret_salt}&quot;

        # Checking if the password matches
        if _decrypted_password == _password_sent:
            return True
        else:
            return False
</pre></div>
</div>
</div>
</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">users</span></code> data model there are the following collumns:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>* `id`: the primary key
* `username`: the username
* `password`: the hashed password
* `email`: the email address of the user
* `enabled`: whether the user is enabled or not. If the user is not enabled, he/she will not be able to query the ML API.
* `created_at`: the date of registration 
* `updated_at`: the date of last update
</pre></div>
</div>
<p>The above collumns allows to fully control the users when they are using our API. The collumn <code class="docutils literal notranslate"><span class="pre">enabled</span></code> should be changed to True if a certain business rule is met (a monthly subscription, for example).</p>
<div class="section" id="password-obfuscation">
<h2>Password obfuscation<a class="headerlink" href="#password-obfuscation" title="Permalink to this headline">¶</a></h2>
<p>One of the main concerns when putting user information on a database is how to store their passwords. If we store them in plain text in the database, anyone who has access to the database can see the passwords. Additionally, if the database is compromised, the passwords can be used to login to the database. To combat this, we will <code class="docutils literal notranslate"><span class="pre">encrypt</span></code> the passwords before storing them in the database.</p>
<p><code class="docutils literal notranslate"><span class="pre">Encription</span></code> is a process of converting a piece of information into random data which can be deciphered with a key.</p>
<p>In our case, the key is stored in the file <code class="docutils literal notranslate"><span class="pre">config.yml</span></code> which is stored in the server. Additionaly, we add <code class="docutils literal notranslate"><span class="pre">salt</span></code> - a random string that is added to the password before hashing. This is done to make the password more secure, because even if the password is compromised, the salt will be different on different servers.</p>
<p>Thus, the full flow of obfuscating the user defined passwords:</p>
<ol class="simple">
<li><p>Salt is added to the original password.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">Fernet</span></code> object is created with the secret key.</p></li>
<li><p>The salt and the password are passed to the <code class="docutils literal notranslate"><span class="pre">encrypt</span></code> method of the <code class="docutils literal notranslate"><span class="pre">Fernet</span></code> object.</p></li>
<li><p>The encrypted password is stored in the database.</p></li>
</ol>
<p>The <code class="docutils literal notranslate"><span class="pre">Fernet</span></code> class implement the symetric encryption algorithm. The basis of the symetric encryption is the <strong>key</strong> - the random string which we must save and not share with anyone. Only having the key can we decrypt the data.</p>
</div>
<div class="section" id="user-registration-endpoints">
<h2>User registration endpoints<a class="headerlink" href="#user-registration-endpoints" title="Permalink to this headline">¶</a></h2>
<p>The endpoints are:</p>
<p><strong>/register-user</strong> - registers a user. The endpoint accepts a POST request with the following data:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">username</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">password</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">email</span><span class="o">&gt;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>/toggle-user-permission/&lt;user_id&gt;/&lt;0 to disable or 1 to enable&gt;</strong> - PUT type endpoint. Toggles the <code class="docutils literal notranslate"><span class="pre">enabled</span></code> collumn of a user.</p>
<p><strong>/remove-user/&lt;user_id&gt;</strong> - a DELETE request that removes a user via the user_id.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Importing the request lib  </span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="c1"># Defining the base URL</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:8001&quot;</span>

<span class="c1"># Defining the user dict </span>
<span class="n">user_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span>
    <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span>
    <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;test@testmail.com&quot;</span>
<span class="p">}</span>

<span class="c1"># Sending the post request to the running API </span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">/register-user&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">user_dict</span><span class="p">)</span>

<span class="c1"># Getting the user id </span>
<span class="n">user_id</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">)</span>

<span class="c1"># Printing the response </span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">; Response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Response code: 409; Response: {&#39;message&#39;: &#39;User already exists&#39;, &#39;user_id&#39;: 10}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Querying the whole user database</span>
<span class="kn">from</span> <span class="nn">ML_API.database</span> <span class="kn">import</span> <span class="n">engine</span> 
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span> 

<span class="n">users</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_table</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Obfuscated password:</span><span class="se">\n</span><span class="si">{</span><span class="n">users</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   id          username                                           password  \
0   4          eligijus  gAAAAABh0ZTKq-0Es9-BzQd-KJ2R8dNY70vFlj3OY_hsC2...   
1   5  eligijus_bujokas  gAAAAABh3uroEwCl80d480inMXMCE1TuHjaBYMgmJI3eKL...   
2  10              test  gAAAAABh4_93mQfHPCQ51tEZ6oLqIZPbADDgIHdNDm2fg9...   

                   email           created_datetime  \
0  eligijus@testmail.com 2022-01-02 14:04:26.751085   
1  eligijus@testmail.com 2022-01-12 16:51:20.534979   
2      test@testmail.com 2022-01-16 13:20:23.508369   

            updated_datetime  enabled  
0 2022-01-02 14:04:26.751085     True  
1 2022-01-12 16:51:20.534979     True  
2 2022-01-16 13:20:23.519665    False  

Obfuscated password:
gAAAAABh0ZTKq-0Es9-BzQd-KJ2R8dNY70vFlj3OY_hsC2kdduIQ4HtnFrSPugX4CnsiThmjBNqWmtHT9oJueUWD8N-mDy8UWP0nmCBlGUnikJzOQzj8tq0=
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Deleting the test user </span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">/remove-user/</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">; Response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Response code: 200; Response: {&#39;message&#39;: &#39;User deleted successfully&#39;}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Adding the test user once again and disabling it </span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">/register-user&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">user_dict</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">; Response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Saving the user id </span>
<span class="n">user_id</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">)</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">/toggle-user-permission/</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">/0&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">; Response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Response code: 201; Response: {&#39;message&#39;: &#39;User created successfully&#39;, &#39;user_id&#39;: 11}
Response code: 200; Response: {&#39;message&#39;: &#39;User permission updated successfully&#39;, &#39;user_id&#39;: 11}
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="summary">
<h1>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h1>
<p>To summarize, we have created a table called <code class="docutils literal notranslate"><span class="pre">users</span></code> in the database and the only way to interact with it is through 3 endpoints:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>* (POST) `/register-user` 
* (PUT) `/toggle-user-permission/&lt;user_id&gt;/&lt;0 to disable or 1 to enable&gt;`
* (DELETE) `/remove-user/&lt;user_id&gt;` 
</pre></div>
</div>
<p>The passwords in the <code class="docutils literal notranslate"><span class="pre">users</span></code> table are encrypted and safe.</p>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./chapter-7-final-serving"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="../chapter-6-production-tools/migrations.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">Migrations</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="authentification.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">ML users authentification</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Eligijus Bujokas<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>